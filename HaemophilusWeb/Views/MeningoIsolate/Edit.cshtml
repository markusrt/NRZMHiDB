@using HaemophilusWeb.Models
@using HaemophilusWeb.Views.Utils
@model HaemophilusWeb.ViewModels.MeningoIsolateViewModel

@{
    ViewBag.Title = "Isolat bearbeiten";
    ViewBag.Controller = "MeningoPatientSending";
    //ViewBag.SecondarySubmit = "Änderungen speichern und Befund erstellen";
}

@section EditModel
{
<div id="exTab2" class="container">
    <ul class="nav nav-tabs">
        <li class="active">
            <a  href="#generalTab" data-toggle="tab">Allgemein</a>
        </li>
        <li><a href="#pubMLSTTab" data-toggle="tab">PubMLST</a>
        </li>
    </ul>

    <div class="tab-content ">
        <div class="tab-pane active" id="generalTab">
            <p></p>
            @Html.ValidationSummary(true)
            @Html.HiddenFor(model => model.MeningoIsolateId)

            @Html.TextEditorFor(m => m.LaboratoryNumber)

            @Html.ReadonlyFor(m => m.SamplingLocation)
            @Html.ReadonlyFor(m => m.Material)
            @Html.ReadonlyFor(m => m.Invasive)
            @Html.ReadonlyFor(m => m.PatientAgeAtSampling)

            @Html.EnumRadioEditorFor(model => model.GrowthOnBloodAgar)

            @Html.EnumRadioEditorFor(model => model.GrowthOnMartinLewisAgar)

            @Html.TextEditorFor(m => m.StemNumber)

            @Html.EnumRadioEditorFor(model => model.Oxidase)

            @Html.EnumRadioEditorFor(model => model.Agglutination, "col-sm-10")

            @Html.EnumRadioEditorFor(model => model.Onpg)

            @Html.EnumRadioEditorFor(model => model.GammaGt)

            <div class="form-group">
                <label class="col-sm-2 control-label">E-Test Messwerte</label>
            </div>

            @Html.EditorFor(model => model.EpsilometerTestViewModels)

            @Html.EnumRadioEditorFor(model => model.SerogroupPcr)

            @Html.TextEditorFor(model => model.PorAVr1)

            @Html.TextEditorFor(model => model.PorAVr2)

            @Html.TextEditorFor(model => model.FetAVr)

            @Html.TextEditorFor(model => model.RplF)

            @Html.EnumRadioEditorFor(model => model.RibosomalRna16S)
            <div id="RibosomalRna16SMatchInPercentForm" class="form-group">
                @Html.LabelFor(m => m.RibosomalRna16SMatchInPercent, new { @class = "col-sm-2 control-label" })
                <div class="col-sm-4">
                    @Html.TextBoxFor(m => m.RibosomalRna16SBestMatch, new { @class = "form-control", placeholder = "Beste Übereinstimmung" })
                    @Html.ValidationMessageFor(model => model.RibosomalRna16SBestMatch)
                </div>
                <div class="col-sm-3">
                    <div class="input-group">
                        @Html.TextBoxFor(m => m.RibosomalRna16SMatchInPercent, new { @class = "form-control", placeholder = "in Prozent" })
                        <span class="input-group-addon">%</span>
                    </div>
                    @Html.ValidationMessageFor(model => model.RibosomalRna16SMatchInPercent)
                </div>
            </div>

            @Html.EnumRadioEditorFor(model => model.ApiNh)
            <div id="ApiNhMatchInPercentForm" class="form-group">
                @Html.LabelFor(m => m.ApiNhMatchInPercent, new { @class = "col-sm-2 control-label" })
                <div class="col-sm-4">
                    @Html.TextBoxFor(m => m.ApiNhBestMatch, new { @class = "form-control", placeholder = "Beste Übereinstimmung" })
                    @Html.ValidationMessageFor(model => model.ApiNhBestMatch)
                </div>
                <div class="col-sm-3">
                    <div class="input-group">
                        @Html.TextBoxFor(m => m.ApiNhMatchInPercent, new { @class = "form-control", placeholder = "in Prozent" })
                        <span class="input-group-addon">%</span>
                    </div>
                    @Html.ValidationMessageFor(model => model.ApiNhMatchInPercent)
                </div>
            </div>

            @Html.EnumRadioEditorFor(model => model.MaldiTof)
            <div id="MaldiTofMatchConfidenceForm" class="form-group">
                @Html.LabelFor(m => m.MaldiTofMatchConfidence, new { @class = "col-sm-2 control-label" })
                <div class="col-sm-4">
                    @Html.TextBoxFor(m => m.MaldiTofBestMatch, new { @class = "form-control", placeholder = "Beste Übereinstimmung" })
                    @Html.ValidationMessageFor(model => model.MaldiTofBestMatch)
                </div>
                <div class="col-sm-3">
                    <div class="input-group">
                        @Html.TextBoxFor(m => m.MaldiTofMatchConfidence, new { @class = "form-control", @placeholder = "Konfidenzwert" })
                        <span class="input-group-addon">00,0</span>
                    </div>
                    @Html.ValidationMessageFor(model => model.MaldiTofMatchConfidence)
                </div>
            </div>

            @Html.DateEditorFor(model => model.ReportDate)

            <div class="form-group">
                @Html.LabelFor(m => m.Remark, new { @class = "col-sm-2 control-label" })
                <div class="col-sm-5">
                    @Html.TextAreaFor(m => m.Remark, new { @class = "form-control", @rows = "5" })
                </div>
            </div>
        </div>
        <div class="tab-pane" id="pubMLSTTab">
            <p></p>
            <div class="form-group">
                <label class="col-sm-2 control-label" for="PubMlstIsolateId">Isolat Nummer</label>
                <div class="col-sm-5">
                    <input class="form-control" id="PubMlstIsolateId" placeholder="35105" type="text">
                </div>
                <div class="col-sm-2">
                    <button class="btn btn-info" type="button" id="PubMlstQuery" data-loading-text="Abfrage läuft <i class='glyphicon glyphicon-time'></i>">Abfragen</button>
                </div>
                <div class="col-sm-2">
                    <span class="label label-warning" id="PubMlstIsolateNotFound" style="display: none;">Isolat wurde nicht gefunden</span>
                    <span class="label label-success" id="PubMlstIsolateFound" style="display: none;">Isolat wurde geladen</span>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">ST</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-SequenceType" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">cc</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-ClonalComplex" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">PorA-VR1</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-PorAVr1" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">PorA-VR2</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-PorAVr2" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">FetA-VR</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-FetAVr" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Por-B</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-PorB" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">fHbp</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-Fhbp" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">NHBA</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-Nhba" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">nadA</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-NadA" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">penA</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-PenA" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">NHBA</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-GyrA" type="text" readonly>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">parC</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-ParC" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">parE</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-ParE" type="text" readonly>
                </div>
                <label class="col-sm-2 control-label">rpoB</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-RpoB" type="text" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">rplF</label>
                <div class="col-sm-2">
                    <input class="form-control" id="PM-RplF" type="text" readonly>
                </div>
            </div>

        </div>
</div></div>


}

@section Scripts{
    <script>
    preventSiteNavigationWithPendingChanges();

    var clinicalBreakpoints = @(Html.Raw(Json.Encode(ViewBag.ClinicalBreakpoints)));

    $(document)
        .ready(function() {
            $("select[id$=_EucastClinicalBreakpointId]").change(ETestChange);
            $("select[id$=_Measurement]").change(ETestChange);
            $("select[id$=_Antibiotic]").change(ETestChange);
            ShowRibosomalRna16SMatchInPercentIfDeterminedIsSelected();
            ShowRibosomalRna16SMatchInPercentIfDeterminedIsSelected();
            ShowApiNhMatchInPercentIfDeterminedIsSelected();
            ShowMaldiTofMatchConfidenceIfDeterminedIsSelected();

            $("#PubMlstQuery").click(QueryPubMlstDatabase);
            $("#PubMlstIsolateId").keypress(QueryPubMlstDatabaseKeypress);

        });

    function QueryPubMlstDatabaseKeypress(e) {
        if (e.keyCode == '13') {
            e.preventDefault();
            QueryPubMlstDatabase();
        }
    }

    function QueryPubMlstDatabase() {
        var fields = [
            "PorAVr1", "PorAVr2", "FetAVr", "PorB", "Fhbp", "Nhba", "NadA", "PenA", "GyrA", "ParC", "ParE", "RpoB",
            "RplF", "SequenceType", "ClonalComplex"
        ];
        var id = $("#PubMlstIsolateId").val();

        $("#PubMlstIsolateNotFound").hide();
        $("#PubMlstIsolateFound").hide();

        if (!id) {
            $("#PubMlstIsolateNotFound").show();
            return;
        }

        $("#PubMlstQuery").button("loading");

        $.ajax("@Url.Content("~/PubMlst/NeisseriaIsolates/")", {method:"POST",data:{ isolateId: $("#PubMlstIsolateId").val() }} )
        .done(function (data) {
            fields.forEach(v => $('#PM-' + v).val(data[v]));
            $("#PubMlstIsolateFound").show();
        })
        .fail(function () {
            fields.forEach(v => $('#PM-' + v).val(""));
            $("#PubMlstIsolateNotFound").show();
        })
        .always(function() {
            $("#PubMlstQuery").button("reset");
        });
     }

    function FindEntry(alleleIds, key) {
        var result = alleleIds.find(a => a[key] !== undefined);
        if (result) {
            return result[key];
        }
        return "";
    }

    function ShowRibosomalRna16SMatchInPercentIfDeterminedIsSelected() {
        ShowDivIfInputHasSpecificSelectedValueOrClearInputOtherwise(
            "#RibosomalRna16SMatchInPercentForm",
            "input:radio[name$='RibosomalRna16S']",
            "input:radio[name$='RibosomalRna16S']:checked",
            "Determined",
            "[id$='RibosomalRna16SBestMatch']",
            "[id$='RibosomalRna16SMatchInPercent']"
        );
    }

    function ShowApiNhMatchInPercentIfDeterminedIsSelected() {
        ShowDivIfInputHasSpecificSelectedValueOrClearInputOtherwise(
            "#ApiNhMatchInPercentForm",
            "input:radio[name$='ApiNh']",
            "input:radio[name$='ApiNh']:checked",
            "Determined",
            "[id$='ApiNhBestMatch']",
            "[id$='ApiNhMatchInPercent']"
        );
    }

    function ShowMaldiTofMatchConfidenceIfDeterminedIsSelected() {
        ShowDivIfInputHasSpecificSelectedValueOrClearInputOtherwise(
            "#MaldiTofMatchConfidenceForm",
            "input:radio[name$='MaldiTof']",
            "input:radio[name$='MaldiTof']:checked",
            "Determined",
            "[id$='MaldiTofBestMatch']",
            "[id$='MaldiTofMatchConfidence']"
        );
    }

    function ETestChange() {
        var id = $(this).attr('id');
        var indexOfSeparator = id.indexOf('__');
        var prefix = id.substring(0, indexOfSeparator);
        var suffix = id.substring(indexOfSeparator + 2);
        var currentBreakpointSelector = '#' + prefix + '__EucastClinicalBreakpointId';
        var currentMeasurementSelector = '#' + prefix + '__Measurement';

        SetETestResult(prefix, null);

        if (suffix === "Antibiotic") {
            var antibiotic = $(this).val();

            $(currentBreakpointSelector)
                .find('option')
                .remove();
            $(currentBreakpointSelector).append('<option value>Auswählen...</option>');

            if (antibiotic === "") {
                $(currentMeasurementSelector).val("");
                return;
            }

            clinicalBreakpoints.forEach(function(clinicalBreakpoint) {
                if (antibiotic == clinicalBreakpoint.Antibiotic) {
                    $(currentBreakpointSelector)
                        .append(
                            '<option value="' + clinicalBreakpoint.EucastClinicalBreakpointId + '">' + clinicalBreakpoint.Title + '</option>'
                        );
                }
            });
        }


        var currentMeasurement = Globalize.parseFloat($(currentMeasurementSelector).val());
        if (isNaN(currentMeasurement)) {
            return;
        }

        if (currentMeasurement > 0 && $(currentBreakpointSelector).prop("selectedIndex") == 0) {
            $(currentBreakpointSelector).prop("selectedIndex", 1);
        } else if (currentMeasurement == 0) {
            $(currentBreakpointSelector).prop("selectedIndex", 0);
        }

        var currentBreakpointId = parseInt($(currentBreakpointSelector).val());

        clinicalBreakpoints.forEach(function(clinicalBreakpoint) {
                if (currentBreakpointId === clinicalBreakpoint.EucastClinicalBreakpointId) {
                    if (clinicalBreakpoint.NoEucastAvailable) {
                        SetETestResult(prefix, '@(EpsilometerTestResult.NotDetermined.ToString())');
                    } else if (currentMeasurement > clinicalBreakpoint.MicBreakpointResistent) {
                        SetETestResult(prefix, '@(EpsilometerTestResult.Resistant.ToString())');
                    } else if (currentMeasurement <= clinicalBreakpoint.MicBreakpointSusceptible) {
                        SetETestResult(prefix, '@(EpsilometerTestResult.Susceptible.ToString())');
                    } else if (currentMeasurement != null) {
                        SetETestResult(prefix, '@(EpsilometerTestResult.Intermediate.ToString())');
                    }
                }
            });
        }

        function SetETestResult(prefix, result) {
            var resultSelector = '#' + prefix + '__Result';

            $(resultSelector).val('');
            $(resultSelector).parent().find(".label").hide();

            if (result != null) {
                $(resultSelector).parent().find(".label-etest-" + result).show();
                $(resultSelector).val(result);
            }
        }

    </script>
}